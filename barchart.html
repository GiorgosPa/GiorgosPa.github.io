<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3: Scaled scatterplot, resized to be bigger!</title>
        <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
        <style type="text/css">
            /* No style rules here yet */		
        </style>
    </head>
    <body>
        <div id="hist"></div>
        <div><button>toggle</button></div>
        <script type="text/javascript">
            var svg;
            function init_hist(rect, xScale, yScale, hScale) {
                rect
                        .attr("x", function (d, i) {
                            return xScale(i);
                        })
                        .attr("y", function (d) {
//                            console.log("d: "+d.count+" scale:"+yScale(d.count));
                            return yScale(d.count);
                        })
                        .attr("width", xScale.rangeBand())
                        .attr("height", function (d) {
                            return hScale(d.count);
                        })
                        .attr("fill", function (d) {
                            return "rgb(0, 0, " + (d.count * 10) + ")";
                        })
                        ;
            }

            function init_text(text_, xScale, yScale, hScale) {

                text_
                        .text(function (d) {
                            return d.count;
                        })
                        .attr("x", function (d, i) {
                            return xScale(i);
                        })
                        .attr("y", function (d) {
                            return yScale(d.count) - 2;
                        })
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "12px")
                        .attr("fill", "black");
            }

            function init_xScale(dataset) {
                //Create scale functions
                var xScale = d3.scale.ordinal()
                        .domain(d3.range(dataset.length))
                        .rangeRoundBands([0, w], 0.05);
                return xScale;
            }
            ;
            function init_yScale(dataset) {
                var yScale = d3.scale.linear()
                        .domain([d3.max(dataset, function (d) {
                                return d.count;
                            }), 0])
                        .range([top_padding, h]);
                return yScale;
            }

            function init_hScale(dataset) {
                var hScale = d3.scale.linear()
                        .domain([0, d3.max(dataset, function (d) {
                                return d.count;
                            })])
                        .range([0, h - top_padding]);
                return hScale;
            }

            function load_hist(file_name) {
                d3.csv(file_name, function (dataset) {
//                    DATA_ = dataset;
                    dataset.forEach(function (d) {
                        d.count = +d.count;
                    });
                    //Create SVG element
                    svg = d3.select("#hist")
                            .append("svg")
                            .attr("width", w)
                            .attr("height", h);
                    var xScale = init_xScale(dataset);
                    var yScale = init_yScale(dataset);
                    var hScale = init_hScale(dataset);

                    rect = svg.selectAll("rect")
                            .data(dataset)
                            .enter()
                            .append("rect");
                    init_hist(rect, xScale, yScale, hScale);
                    rect
                        .on("mouseover", function () {
                            d3.select(this)
                                    .attr("fill", "orange");
                        })
                        .on("mouseout", function (d) {
                            d3.select(this)
                                    .transition()
                                    .duration(250)
                                    .attr("fill", "rgb(0, 0, " + (d.count * 10) + ")")
                        })

                    text_ = svg.selectAll("text")
                            .data(dataset)
                            .enter()
                            .append("text");
                    init_text(text_, xScale, yScale, hScale);
                });
            }

            function upd_hist(file_name) {
                d3.csv(file_name, function (dataset) {
                    dataset.forEach(function (d) {
                        d.count = +d.count;
                    });
                    var xScale = init_xScale(dataset);
                    var yScale = init_yScale(dataset);
                    var hScale = init_hScale(dataset);
                    //Update all rects
                    var rect = svg.selectAll("rect")
                            .data(dataset)
                            .transition()
                            .delay(function (d, i) {
                                return i / dataset.length * 1000;
                            })
                            .duration(500);
                    init_hist(rect, xScale, yScale, hScale);

                    //Update all labels
                    var text_ = svg.selectAll("text")
                            .data(dataset)
                            .transition()
                            .delay(function (d, i) {
                                return i / dataset.length * 1000;
                            })
                            .duration(500);
                    init_text(text_, xScale, yScale, hScale);
                });
            }
            //Width and height
            var w = 1000;
            var h = 500;
            var top_padding = 20;
            var filename="barchart/output0.csv";
            load_hist(filename);
            d3.select("button")
                    .on("click", function () {
                        if(filename==="barchart/output0.csv") {
                            filename = "barchart/output1.csv";
                        } else {
                            filename = "barchart/output0.csv";
                        }
                        upd_hist(filename);
                    });
        </script>
    </body>
</html>